
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Long running PHP script and MySQL server gone away - Thijs Lensselink's Blog</title>
  <meta name="author" content="Thijs Lensselink">

  
  <meta name="description" content="Long Running PHP Script and MySQL Server Gone Away At the moment i am writing some workers that interact with a beanstalk server. When data gets &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tlenss.github.com/2012/10/29/long-running-php-script-and-mysql-server-gone-away/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/style.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/libs/jquery-1.8.1.js"></script>
  <link href="http://feeds.feedburner.com/ThijsLensselinksBlog" rel="alternate" title="Thijs Lensselink's Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8003524-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script type="text/javascript">
	$(document).ready(function() {
		$('#logo').click(function() {
			window.location = '/';
		});
	});
  </script>
</head>

<body   >
<div id="content">
	<div class="inner">
        <div>
<article class="hentry" role="article">
  
<article>
	<header>
		<header>
		
		  <h1 class="entry-title">Long Running PHP Script and MySQL Server Gone Away</h1>
		
		</header>
	</header>

	
	<div class="articletext"><p>At the moment i am writing some workers that interact with a <a href="http://kr.github.com/beanstalkd/">beanstalk</a> server. When data gets pushed into the beanstalk server. My workers will be triggered to process this data. So the workers are sitting idle for most of the time. And just wait for some data to process. No rocket science there. But during testing i kept running into <a href="http://www.mysql.com/">MySQL</a> issues. The script seemed to lose connection to the MySQL server when it was idle for longer then a minute. And would respond with a</p>

<blockquote><p>Warning: <a href="http://php.net/mysql_query">mysql_query</a>(): MySQL server has gone away in /path/to/some/mysql4/class.php on line xxx</p></blockquote>

<p>So whats going on here? Well actually it&#8217;s quite simple. When my script initializes the database connection it doesn&#8217;t use it. It just sits there waiting for incoming data. Once received it will process it and try to store it in the database. But when the waiting period exceeds the time for PHP to keep the MySQL connection open it responds with the warning mentioned above. Now in previous versions of PHP this would not be a big issue. As PHP would just initiate a reconnect when the connection is lost. But from PHP 5.0.3 and up this functionality has been disabled by default. For MySQLI this is no problem at all.</p>

<p>MySQLi:</p>

<blockquote><p>mysqli.reconnect = Off to On</p></blockquote>

<p>Unfortunately i am working with PHP&#8217;s core mysql_* functions (don&#8217;t get me started) and there doesn&#8217;t seem to be an easy way to resolve this. According to the MySQL documentation</p>

<pre><code>mysql_options(&amp;mysql;, MYSQL_OPT_RECONNECT, &amp;reconnect;);
</code></pre>

<p>Should do the trick. But passing <strong>MYSQL_OPT_RECONNECT</strong> in anyway to <a href="http://php.net/mysql_connect">mysql_connect</a> didn&#8217;t result in the result i was looking for. So what now? Porting the database code to make use of the newer and better PDO or MySQLi is no option. As it would consume way to much time. Fortunately the mysql_* core functions come with mysql_ping. I never had to use this before. But in this case it comes in quite handy.</p>

<p><strong>From the PHP manual:</strong></p>

<pre><code>bool mysql_ping ([ resource $link_identifier = NULL ] )
</code></pre>

<blockquote><p>Checks whether or not the connection to the server is working. If it has gone down, an automatic reconnection is attempted. This function can be used by scripts that remain idle for a long while, to check whether or not the server has closed the connection and reconnect if necessary.</p></blockquote>

<p>Note:
<strong>Automatic reconnection is disabled by default in versions of MySQL >= 5.0.3.</strong></p>

<p>Adding the mysql_ping function call was rather straight forward. And didn&#8217;t require all that much work to be done. I extended the database class to include a ping method. That would simply throw an exception when it failed to reconnect.</p>

<pre><code>public function ping()
{
    if (!mysql_ping($this-&gt;db_connect_id)) {
        throw new Mollie_Database_Exception("Connection was lost");
    }   
    return true;
}
</code></pre>

<p>And after that i started poking around the userland implementation. The worker is running inside a <strong>while(true)</strong> loop. A first test with <strong>->ping()</strong> being called inside this loop proved to resolve the issue at hand. But running the ping function that often is overkill. And who knows it might actually result in <strong>DoS</strong> of the database server. So i decided to ping the server every one minute or so.</p>

<pre><code>$start = time();
while (true) 
{
    $this-&gt;_keepConnectionAlive($start);
</code></pre>

<p>And the keepConnectionAlive method looks something like this</p>

<pre><code>protected function _keepConnectionAlive(&amp;$start)
{
    $passed = (time() - $start);
    if ($passed &gt; 60)
    {
        $start = time();
        $this-&gt;_db-&gt;ping();
    }
}
</code></pre>

<p>I&#8217;m not a big fan of this solution. And would rather be implementing MySQLi functions. But this functions well. And will do for now.</p>
</div>
	

	<div style="clear:both;"></div>
	<footer>
		on 








  


<time datetime="2012-10-29T14:39:26+01:00" pubdate data-updated="true">Oct 29<span>th</span>, 2012</time>
		<div class="share">
			<ul>
				<li><a href="#disqus_thread">Comments</a></li>
			</ul>
		</div>
	</footer>
</article>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Thijs Lensselink</span></span>

      








  


<time datetime="2012-10-29T14:39:26+01:00" pubdate data-updated="true">Oct 29<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/categories/code/'>Code</a>, <a class='category' href='/categories/php/'>PHP</a>, <a class='category' href='/categories/sql/'>SQL</a>, <a class='category' href='/categories/tech/'>Tech</a>, <a class='category' href='/categories/zend/'>Zend</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://tlenss.github.com/2012/10/29/long-running-php-script-and-mysql-server-gone-away/" data-via="tlenss" data-counturl="http://tlenss.github.com/2012/10/29/long-running-php-script-and-mysql-server-gone-away/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2012/10/25/git-rebase-on-pull-by-default/" title="Previous Post: Git: Rebase on pull by default">&laquo; Git: Rebase on pull by default</a>
      
      
        <a class="basic-alignment right" href="/2012/11/07/publish-google-reader-shared-items/" title="Next Post: Publish Google Reader shared items">Publish Google Reader shared items &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>
	</div>
</div>

<div id="sidebar">
  
    Liquid syntax error: if tag was never closed
  
</div>

<footer role="contentinfo"><p>
  Copyright &copy; 2012 - Thijs Lensselink -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tlenss';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://tlenss.github.com/2012/10/29/long-running-php-script-and-mysql-server-gone-away/';
        var disqus_url = 'http://tlenss.github.com/2012/10/29/long-running-php-script-and-mysql-server-gone-away/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>