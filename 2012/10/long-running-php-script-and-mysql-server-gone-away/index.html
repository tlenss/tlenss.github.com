
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Long running PHP script and MySQL server gone away - Thijs Lensselink's Blog</title>
  <meta name="author" content="Thijs Lensselink">

  
  <meta name="description" content="Long Running PHP Script and MySQL Server Gone Away At the moment i am writing some workers that interact with a beanstalk server. When data gets &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lenss.nl/2012/10/long-running-php-script-and-mysql-server-gone-away/">
  <link href="http://lenss.nl/favicon.png" rel="icon">
  <link href="http://lenss.nl/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="http://lenss.nl/javascripts/libs/jquery-1.8.1.js"></script>
  <script src="http://lenss.nl/javascripts/modernizr-2.0.js"></script>
  <script src="http://lenss.nl/javascripts/ender.js"></script>
  <script src="http://lenss.nl/javascripts/octopress.js"></script>
  <script src="http://lenss.nl/javascripts/github.js"></script>
  <script src="http://lenss.nl/javascripts/twitter.js"></script>
  <script type="text/javascript" src="http://lenss.nl/javascripts/jquery.cookie.min.js"></script>
  <script type="text/javascript" src="http://lenss.nl/javascripts/adn-timeline.js"></script>
  <link href="http://feeds.feedburner.com/ThijsLensselinksBlog" rel="alternate" title="Thijs Lensselink's Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8003524-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script type="text/javascript">
	$(document).ready(function() {
		$('#logo').click(function() {
			window.location = '/';
		});
	});
  </script>
</head>

<body   >
<div id="content">
	<div class="inner">
        <div>
<article class="hentry" role="article">
  
<header>
	<header>
	
	  <h1 class="entry-title">Long Running PHP Script and MySQL Server Gone Away</h1>
	
	</header>
</header>


<div class="articletext"><p>At the moment i am writing some workers that interact with a <a href="http://kr.github.com/beanstalkd/">beanstalk</a> server. When data gets pushed into the beanstalk server. My workers will be triggered to process this data. So the workers are sitting idle for most of the time. And just wait for some data to process. No rocket science there. But during testing i kept running into <a href="http://www.mysql.com/">MySQL</a> issues. The script seemed to lose connection to the MySQL server when it was idle for longer then a minute. And would respond with a </p>

<blockquote>
  <p>Warning: <a href="http://php.net/mysql_query">mysql_query</a>(): MySQL server has gone away in /path/to/some/mysql4/class.php on line xxx</p>
</blockquote>

<p>So whats going on here? Well actually it’s quite simple. When my script initializes the database connection it doesn’t use it. It just sits there waiting for incoming data. Once received it will process it and try to store it in the database. But when the waiting period exceeds the time for PHP to keep the MySQL connection open it responds with the warning mentioned above. Now in previous versions of PHP this would not be a big issue. As PHP would just initiate a reconnect when the connection is lost. But from PHP 5.0.3 and up this functionality has been disabled by default. For MySQLI this is no problem at all. </p>

<p>MySQLi:</p>

<blockquote>
  <p>mysqli.reconnect = Off to On</p>
</blockquote>

<p>Unfortunately i am working with PHP’s core mysql_* functions (don’t get me started) and there doesn’t seem to be an easy way to resolve this. According to the MySQL documentation</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
mysql_options(&amp;mysql;, <span class="constant">MYSQL_OPT_RECONNECT</span>, &amp;reconnect;);
</pre></div>
</div>
 </figure></notextile></div>

<p>Should do the trick. But passing <strong>MYSQL_OPT_RECONNECT</strong> in anyway to <a href="http://php.net/mysql_connect">mysql_connect</a> didn’t give me the result i was looking for. So what now? Porting the database code to make use of the newer and better PDO or MySQLi is no option. As it would consume way to much time. Fortunately the mysql_* core functions come with mysql_ping. I never had to use this before. But in this case it comes in quite handy.</p>

<p><strong>From the PHP manual:</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>
<span class="predefined-type">bool</span> mysql_ping ([ <span class="predefined-type">resource</span> <span class="local-variable">$link_identifier</span> = <span class="predefined-constant">NULL</span> ] )
</pre></div>
</div>
 </figure></notextile></div>

<blockquote>
  <p>Checks whether or not the connection to the server is working. If it has gone down, an automatic reconnection is attempted. This function can be used by scripts that remain idle for a long while, to check whether or not the server has closed the connection and reconnect if necessary.</p>
</blockquote>

<p>Note:
<strong>Automatic reconnection is disabled by default in versions of MySQL &gt;= 5.0.3.</strong></p>

<p>Adding the mysql_ping function call was rather straight forward. And didn’t require all that much work to be done. I extended the database class to include a ping method. That would simply throw an exception when it failed to reconnect. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header" style="margin-bottom:-5px;"><span>MySQL ping function </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">public</span> <span class="keyword">function</span> <span class="function">ping</span>()
{
  <span class="keyword">if</span> (!mysql_ping(<span class="local-variable">$this</span>-&gt;db_connect_id)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="constant">Mollie_Database_Exception</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Connection was lost</span><span class="delimiter">&quot;</span></span>);
  }        
  <span class="keyword">return</span> <span class="predefined-constant">true</span>;
}
</pre></div>
</div>
 </figure></notextile></div>

<p>And after that i started poking around the userland implementation. The worker is running inside a <strong>while(true)</strong> loop. A first test with <strong>-&gt;ping()</strong> being called inside this loop proved to resolve the issue at hand. But running the ping function that often is overkill. And who knows it might actually result in <strong>DoS</strong> of the database server. So i decided to ping the server every one minute or so.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header" style="margin-bottom:-5px;"><span>Keep the connection alive </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre>
<span class="local-variable">$start</span> = <span class="predefined">time</span>();
<span class="keyword">while</span> (<span class="predefined-constant">true</span>) 
{
  <span class="local-variable">$this</span>-&gt;_keepConnectionAlive(<span class="local-variable">$start</span>);
}
</pre></div>
</div>
 </figure></notextile></div>

<p>And the keepConnectionAlive method looks something like this</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header" style="margin-bottom:-5px;"><span>keepConnectionAlive method </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">protected</span> <span class="keyword">function</span> <span class="function">_keepConnectionAlive</span>(&amp;<span class="local-variable">$start</span>)
{
  <span class="local-variable">$passed</span> = (<span class="predefined">time</span>() - <span class="local-variable">$start</span>);
  <span class="keyword">if</span> (<span class="local-variable">$passed</span> &gt; <span class="integer">60</span>)
  {
    <span class="local-variable">$start</span> = <span class="predefined">time</span>();
    <span class="local-variable">$this</span>-&gt;_db-&gt;ping();
  }
}
</pre></div>
</div>
 </figure></notextile></div>

<p>I’m not a big fan of this solution. And would rather be implementing MySQLi functions. But this functions well. And will do for now.</p>
</div>


<div style="clear:both;"></div>

  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Thijs Lensselink</span></span>

      








  


<time datetime="2012-10-29T14:39:26+01:00" pubdate data-updated="true">Oct 29<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='http://lenss.nl/tag/code/'>Code</a>, <a class='category' href='http://lenss.nl/tag/php/'>PHP</a>, <a class='category' href='http://lenss.nl/tag/sql/'>SQL</a>, <a class='category' href='http://lenss.nl/tag/tech/'>Tech</a>, <a class='category' href='http://lenss.nl/tag/zend/'>Zend</a>
  
</span>


    </p>
    <p class="meta">
      
        <a class="basic-alignment left" href="http://lenss.nl/2012/10/git-rebase-on-pull-by-default/" title="Previous Post: Git: Rebase on pull by default">&laquo; Git: Rebase on pull by default</a>
      
      
        <a class="basic-alignment right" href="http://lenss.nl/2012/11/publish-google-reader-shared-items/" title="Next Post: Publish Google Reader shared items">Publish Google Reader shared items &raquo;</a>
      
    </p>
  </footer>
</article>

<div style="padding:10px;">

  <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://lenss.nl/2012/10/long-running-php-script-and-mysql-server-gone-away/" data-via="tlenss" data-counturl="http://lenss.nl/2012/10/long-running-php-script-and-mysql-server-gone-away/" >Tweet</a>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>




  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>
</div>

<section class="ad">
	<script type="text/javascript"><!--
	google_ad_client = "ca-pub-0921745317573569";
	/* nlblue_content */
	google_ad_slot = "0947700644";
	google_ad_width = 728;
	google_ad_height = 90;
	//-->
	</script>
	<script type="text/javascript"
	src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
	</script>
</section>

	</div>
</div>

<div id="sidebar">
  
    
<div id="logo" class="sidebox">
	<div id="logo-main">lenss<span class="nl">nl</span></div>
	<div id="logo-sub"><span class="nl">Thijs Lensselink's Blog</span></div>
</div>

<div class="sidebox">
	<a href="http://www.facebook.com/thijs.lensselink#!/" class="social facebook"></a>
	<a href="https://plus.google.com/117496548747841671883" class="social google"></a>
	<a href="http://twitter.com/tlenss" class="social twitter"></a>
	<a href="http://feeds.feedburner.com/ThijsLensselinksBlog" class="social rss"></a>
	<div style="clear:both;"></div>
</div>

<div class="sidebox">
	<h1>Me</h1>
	<div class="me">
		<a href="http://www.zend.com/store/education/certification/yellow-pages.php#show-ClientCandidateID=ZEND006598"><img src="http://lenss.nl/images/php5-zce-logo-new.gif" height="58" /></a>
		<a href="http://stackoverflow.com/users/476697/tlenss">
			<img src="http://stackoverflow.com/users/flair/476697.png?theme=dark" width="208" height="58" alt="profile for tlenss at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for tlenss at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
		</a>
		<a href="http://internetdefenseleague.org"><img src="http://internetdefenseleague.org/images/badges/final/footer_badge.png" alt="Member of The Internet Defense League" height="58" /></a>
		<div class="gpg">
			Key ID : <a href="http://lenss.nl/FE0B2B46.asc">0xFE0B2B46</a><br/>
			Fingerprint : 4826 0FA9 AC98 CE61 BB3D  4046 D6EE FEED FE0B 2B46
		</div>
	</div>
</div>

<section>
  <div class="sidebox">
	<h1>Recent entries</h1>
	<ul class="linklist">
		
		<li><a href="http://lenss.nl/2013/08/github-and-multiple-ssh-keys/"><span class="higlight">August, 2013</span> Github, SSH and multiple repositories</a></li>
		
		<li><a href="http://lenss.nl/2013/07/memory-exhaust-issue-PHP-and-APM/"><span class="higlight">July, 2013</span> Memory exhaust issue PHP and APM</a></li>
		
		<li><a href="http://lenss.nl/2013/06/php-55-released/"><span class="higlight">June, 2013</span> PHP 5.5.0 released</a></li>
		
		<li><a href="http://lenss.nl/2013/03/casting-weirdness-with-PHP/"><span class="higlight">March, 2013</span> Casting weirdness with PHP</a></li>
		
		<li><a href="http://lenss.nl/2013/02/zend-optimizer%2B-integrated-in-5.5/"><span class="higlight">February, 2013</span> Zend Optimizer+ integrated into 5.5</a></li>
		
		<li><a href="http://lenss.nl/2013/02/phpness-serious-wtf/"><span class="higlight">February, 2013</span> PHPness Serious WTF</a></li>
		
		<li><a href="http://lenss.nl/2012/11/publish-google-reader-shared-items/"><span class="higlight">November, 2012</span> Publish Google Reader shared items</a></li>
		
		<li><a href="http://lenss.nl/2012/10/long-running-php-script-and-mysql-server-gone-away/"><span class="higlight">October, 2012</span> Long running PHP script and MySQL server gone away</a></li>
		
		<li><a href="http://lenss.nl/2012/10/git-rebase-on-pull-by-default/"><span class="higlight">October, 2012</span> Git: Rebase on pull by default</a></li>
		
		<li><a href="http://lenss.nl/2012/10/workaround-ubuntu-12-04-mysterious-system-freezes/"><span class="higlight">October, 2012</span> Workaround Ubuntu 12.04 mysterious system freezes</a></li>
		
	</ul>
</div>
</section>

<div class="sidebox ad">
	<script type="text/javascript"><!--
	google_ad_client = "ca-pub-0921745317573569";
	/* nlblue_side */
	google_ad_slot = "7706621160";
	google_ad_width = 300;
	google_ad_height = 250;
	//-->
	</script>
	<script type="text/javascript"
	src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
	</script>
</div>
<div class="sidebox">
	<h1>Tags</h1>
	<ul id="tag-cloud" class="blocklist"><a href='http://lenss.nl/tag/-home' style='font-size: 116.41025641025641%'>/home(32)</a> <a href='http://lenss.nl/tag/code' style='font-size: 160.0%'>Code(117)</a> <a href='http://lenss.nl/tag/design' style='font-size: 103.07692307692308%'>Design(6)</a> <a href='http://lenss.nl/tag/freelance' style='font-size: 102.05128205128204%'>Freelance(4)</a> <a href='http://lenss.nl/tag/git' style='font-size: 100.51282051282051%'>Git(1)</a> <a href='http://lenss.nl/tag/google' style='font-size: 101.53846153846153%'>Google(3)</a> <a href='http://lenss.nl/tag/javascript' style='font-size: 104.1025641025641%'>Javascript(8)</a> <a href='http://lenss.nl/tag/jquery' style='font-size: 101.02564102564102%'>Jquery(2)</a> <a href='http://lenss.nl/tag/magento' style='font-size: 101.02564102564102%'>Magento(2)</a> <a href='http://lenss.nl/tag/php' style='font-size: 134.35897435897436%'>PHP(67)</a> <a href='http://lenss.nl/tag/security' style='font-size: 104.1025641025641%'>Security(8)</a> <a href='http://lenss.nl/tag/sql' style='font-size: 103.07692307692308%'>SQL(6)</a> <a href='http://lenss.nl/tag/tech' style='font-size: 150.25641025641025%'>Tech(98)</a> <a href='http://lenss.nl/tag/zend' style='font-size: 104.1025641025641%'>Zend(8)</a> </ul>
	<div style="clear:both;"></div>
</div>
<section>
  <div class="sidebox">
	<h1>GitHub Repos</h1>
	
	<ul class="linklist" id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/tlenss" class="github-follow-button">Follow On GitHub</a>
  <script type="text/javascript" src="http://octophile.com/widgets.js"></script>
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = 'http://lenss.nl/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tlenss',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="http://lenss.nl/javascripts/github.js" type="text/javascript"> </script>
</div>
</section>

<section>
  <div class="sidebox">
	<h1>Latest Tweets</h1>
	<script type="text/javascript">
  $(document).ready(function(){
    new AdnTimeline();
  });
</script>

<div data-username="tlenss" data-avatars="true" data-count="5" class="adn-timeline"></div>
</div>
</section>


  
</div>

<a href="http://internetdefenseleague.org"><img src="http://internetdefenseleague.org/images/badges/final/banner_right.png" alt="Member of The Internet Defense League" /></a>

<footer role="contentinfo">
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tlenss';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://lenss.nl/2012/10/long-running-php-script-and-mysql-server-gone-away/';
        var disqus_url = 'http://lenss.nl/2012/10/long-running-php-script-and-mysql-server-gone-away/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
