
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Drag & drop Uploads with XMLHttpRequest2 and PHP Revised - Thijs Lensselink's Blog</title>
  <meta name="author" content="Thijs Lensselink">

  
  <meta name="description" content="Drag & Drop Uploads With XMLHttpRequest2 and PHP Revised A while back i wrote a post where i explained how to implement the new XMLHttpRequest2 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tlenss.github.com/2010/09/22/drag-drop-uploads-with-xmlhttprequest2-and-php-revised/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/style.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/libs/jquery-1.8.1.js"></script>
  <link href="http://feeds.feedburner.com/ThijsLensselinksBlog" rel="alternate" title="Thijs Lensselink's Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8003524-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script type="text/javascript">
	$(document).ready(function() {
		$('#logo').click(function() {
			window.location = '/';
		});
	});
  </script>
</head>

<body   >
<div id="content">
	<div class="inner">
        <div>
<article class="hentry" role="article">
  
<article>
	<header>
		<header>
		
		  <h1 class="entry-title">Drag & Drop Uploads With XMLHttpRequest2 and PHP Revised</h1>
		
		</header>
	</header>

	
	<div class="articletext"><p>A while back i wrote a <a href="http://lenss.nl/2010/01/drag-drop-uploads-with-xmlhttprequest2-and-php/">post </a> where i explained how to implement the new XMLHttpRequest2 object. The main point of the post was to use <a href="https://developer.mozilla.org/en/XMLHttpRequest">sendAsBinary()</a> so we can stream file uploads from the client to the server.</p>

<p>The post i made showed some code snippets to make this possible. And the Javascript part is all fine and dandy. But last week i had an interesting mail conversation with <a href="http://braincracking.org/">Jean-Pierre Vincent</a> about the memory consumption on the server side of things.</p>

<p>The result of some testing revealed the server would need at least the amount of memory equal to the file size. For small files this is no problem. But with bigger files this becomes a problem. Although i couldn&#8217;t reproduce Jean-Pierre&#8217;s results. I wasn&#8217;t very happy with the test results.</p>

<blockquote><p>Upload 2.8 MB file results in 3.1 MB memory usage
Upload 29 MB file results in 30 MB memory usage</p></blockquote>

<p>A bit more testing revealed that <a href="http://php.net/manual/function.file-put-contents.php">file_put_contents()</a> was the culprit. Which seems logical if you think about it. It reads the file into memory and dumps it again. Not very elegant for big files. Besides we are trying to stream files. So why should we read them completely in to memory? We shouldn&#8217;t :)</p>

<p>Jean-Pierre decided to go with the DataForm object to solve the issue. I still want to look into that. But have not found any information about. Besides that i knew the problem was on the server side. So i rewrote the receive() method to be less memory intensive. The results are considerably better then before.</p>

<blockquote><p>Upload 2.8 MB file results in 0.4 MB memory usage
Upload 29 MB file results in 0.4 MB memory usage</p></blockquote>

<p>The memory usage was measured with <a href="http://php.net/manual/function.memory-get-peak-usage.php">memory_get_peak_usage()</a>. And the new code is posted below:</p>

<pre><code>public function receive()
{
    if (!$this-&gt;isValid()) {
        throw new Exception('No file uploaded!');
    }

    $fileReader = fopen('php://input', "r");
    $fileWriter = fopen($this-&gt;_destination . $this-&gt;_fileName, "w+");

    while(true) {
        $buffer = fgets($fileReader, 4096);
        if (strlen($buffer) == 0) {
            fclose($fileReader);
            fclose($fileWriter);
            return true;
        }

        fwrite($fileWriter, $buffer);
    }

    return false;
}
</code></pre>
</div>
	

	<div style="clear:both;"></div>
	<footer>
		on 








  


<time datetime="2010-09-22T15:26:42+02:00" pubdate data-updated="true">Sep 22<span>nd</span>, 2010</time>
		<div class="share">
			<ul>
				<li><a href="#disqus_thread">Comments</a></li>
			</ul>
		</div>
	</footer>
</article>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Thijs Lensselink</span></span>

      








  


<time datetime="2010-09-22T15:26:42+02:00" pubdate data-updated="true">Sep 22<span>nd</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/categories/code/'>Code</a>, <a class='category' href='/categories/javascript/'>Javascript</a>, <a class='category' href='/categories/php/'>PHP</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://tlenss.github.com/2010/09/22/drag-drop-uploads-with-xmlhttprequest2-and-php-revised/" data-via="tlenss" data-counturl="http://tlenss.github.com/2010/09/22/drag-drop-uploads-with-xmlhttprequest2-and-php-revised/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2010/09/07/recursive-array-filter/" title="Previous Post: Recursive array filtering">&laquo; Recursive array filtering</a>
      
      
        <a class="basic-alignment right" href="/2010/09/27/zend-studio-goes-virtual/" title="Next Post: Zend Studio goes virtual">Zend Studio goes virtual &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>
	</div>
</div>

<div id="sidebar">
  
    Liquid syntax error: if tag was never closed
  
</div>

<footer role="contentinfo"><p>
  Copyright &copy; 2012 - Thijs Lensselink -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tlenss';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://tlenss.github.com/2010/09/22/drag-drop-uploads-with-xmlhttprequest2-and-php-revised/';
        var disqus_url = 'http://tlenss.github.com/2010/09/22/drag-drop-uploads-with-xmlhttprequest2-and-php-revised/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>