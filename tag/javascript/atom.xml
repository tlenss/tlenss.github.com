<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Javascript | Thijs Lensselink's Blog]]></title>
  <link href="http://lenss.nl/tag/javascript/atom.xml" rel="self"/>
  <link href="http://lenss.nl/"/>
  <updated>2013-06-23T21:20:26+02:00</updated>
  <id>http://lenss.nl/</id>
  <author>
    <name><![CDATA[Thijs Lensselink]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Abbywinters.com is hiring!]]></title>
    <link href="http://lenss.nl/2011/11/abbywinters-com-is-hiring/"/>
    <updated>2011-11-22T14:46:51+01:00</updated>
    <id>http://lenss.nl/2011/11/abbywinters-com-is-hiring</id>
    <content type="html"><![CDATA[<p><a href="http://careers.abbywinters.com/job-opportunities/senior-php-developer/"><img src="http://lenss.nl/images/2011/11/aw-logo-roundel-blue.png" alt="" /></a> If you’re looking for a new challenging and exiting Senior Webdeveloper position. Don’t look any further. If you already think you have the job of your dreams. Think again!</p>

<p><em><a href="http://www.abbywinters.com">abbywinters.com</a> <strong>(NSFW)</strong> is one of the largest and most ethical, highly rated, well designed, and successful erotic websites in the world today. abbywinters.com is the WINNER of the AVN 2011 Awards for Best Membership site!</em></p>

<p>And we are looking to hire a new talented webdeveloper to expand our small team. What would you think about joining our small Agile team of highly qualified professionals? </p>

<p>You will be creating sexy, exiting and game changing experiences for the web, work for one of the industry leaders. And just be part of an awesome company. Some of the jobs key elements are:</p>

<ul>
  <li>
    <p>Implementing development projects</p>
  </li>
  <li>
    <p>Leading informal mentoring during day-to-day work</p>
  </li>
  <li>
    <p>Contribute to design of development projects</p>
  </li>
  <li>
    <p>Track, reduce, and prevent technical debt in Web Development projects</p>
  </li>
</ul>

<blockquote>
  <p>Motivated by principles of social responsibility, we deliver provocative media by embracing imagination, creativity and emerging technologies. Our models, customers and business partners are inspired by our fervid passion.</p>

</blockquote>

<blockquote>

  <p>Our experienced staff use state-of-the-art content production facilities to produce 10 shoots a week from concept to finished art, utilizing the most advanced digital capture, post production and delivery systems in the world.</p>

</blockquote>

<blockquote>

  <p>You will be working directly with our Web Dev Manager, Lead developer and colleagues in the web dev team. We need each individual to contribute for us to continue as a pioneer in our industry.</p>
</blockquote>

<p>If you posses a “Can do” attitude. Would like to work in the center of Amsterdam. And are able to identify your self in the criteria below. You might want to head over to our <a href="http://careers.abbywinters.com/job-opportunities/senior-php-developer/">career portal</a> for a more detailed description.  </p>

<p><strong>Technical competencies – Required</strong></p>

<ul>
  <li>
    <p>High level of skill with PHP 5</p>
  </li>
  <li>
    <p>High level of skill with Object Oriented Programming</p>
  </li>
  <li>
    <p>High level of skill with HTML/CSS</p>
  </li>
  <li>
    <p>High level of skill with JavaScript</p>
  </li>
  <li>
    <p>High level of skill with Internet Applications</p>
  </li>
  <li>
    <p>Moderate level of skill with Unit Testing and Test Driven Design</p>
  </li>
  <li>
    <p>Moderate level of skill with MySQL</p>
  </li>
  <li>
    <p>Moderate level of skill with Windows XP operating system</p>
  </li>
  <li>
    <p>Experience with the GNU/Linux operating system</p>
  </li>
  <li>
    <p>Competent with Revision Control systems (Subversion)</p>
  </li>
  <li>
    <p>Bachelor of Science in Computer Science, or equivalent experience</p>
  </li>
  <li>
    <p>Zend Certified Engineer, or equivalent experience</p>
  </li>
  <li>
    <p>At least 5 years experience in Web Application Development</p>
  </li>
</ul>

<p><strong>Technical competencies – Desired</strong></p>

<ul>
  <li>
    <p>Moderate level of skill with the Apache HTTP server</p>
  </li>
  <li>
    <p>Good understanding of the Model-View-Controller pattern</p>
  </li>
  <li>
    <p>Good understanding of the ActiveRecord Object-Relational-Mapping pattern</p>
  </li>
  <li>
    <p>Familiarity with Agile software development practices (Scrum)</p>
  </li>
  <li>
    <p>E-commerce</p>
  </li>
  <li>
    <p>Agile development experience</p>
  </li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jquery unrecognized expression error]]></title>
    <link href="http://lenss.nl/2011/08/jquery-unrecognized-expression-error/"/>
    <updated>2011-08-20T13:20:59+02:00</updated>
    <id>http://lenss.nl/2011/08/jquery-unrecognized-expression-error</id>
    <content type="html"><![CDATA[<p>While doing some front end work yesterday. I got trapped by a <a href="http://jquery.com/">jQuery</a> issue. Well not JQuery specific. The issue was actually triggered by some other hand crafted code. Every time i would click a link inside my grid view firebug would throw an error.</p>

<blockquote>
  <p>uncaught exception: Syntax error, unrecognized expression: .</p>
</blockquote>

<p>And the markup that triggered the error was</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">zipDownload</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">icon_zipSmall</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/span&gt;</span><span class="tag">&lt;/a&gt;</span>
</pre></div>
</div>
 </figure></notextile></div></p>

<p>Nothing wrong there right? And it actually took my quite some time to figure this one out. It would be nice to have a tool that can tell you there are multiple click events assigned to a element? But for now it was just some manual searching and testing.</p>

<p>The issue was caused by an other snippet of Javascript code inside another .js file. This piece of code attached a click event to every div inside a grid td. Which may be a bit to greedy.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="predefined">$</span>(<span class="error">‘</span>.admin .gridbg tr td span<span class="error">’</span>).click(<span class="keyword">function</span>() {
</pre></div>
</div>
 </figure></notextile></div></p>

<p>And my link was in a nested td inside the grid. And also contained a span tag. So it was actually firing off two click events. From which one failed. Fixing it after that was easy. Either make the first click binding less greedy. Or change the markup of my second grid. I choose the last one.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://lenss.nl</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">zipDownload icon_zipSmall</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/a&gt;</span>
</pre></div>
</div>
 </figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jquery & PHP doing simple image slicing]]></title>
    <link href="http://lenss.nl/2010/11/jquery-php-doing-simple-image-slicing/"/>
    <updated>2010-11-01T17:34:11+01:00</updated>
    <id>http://lenss.nl/2010/11/jquery-php-doing-simple-image-slicing</id>
    <content type="html"><![CDATA[<p>Today i was in need of a basic image slicer. An there must be a million of these things out there. But i wanted to see how hard / easy it would be to create this myself.</p>

<p>Conclusion. It’s not that hard when using the jquery library. which is becoming my Javascript framework of choice.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">js/jquery-1.4.3.min.js</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/javascript</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">js/jquery-ui-1.8.5.custom.min.js</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/javascript</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
</pre></div>
</div>
 </figure></notextile></div></p>

<p>I started with a div.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="entity">&amp;lt;</span>div id=&quot;image_slicer_canvas&quot;<span class="entity">&amp;gt;</span><span class="entity">&amp;lt;</span>/div<span class="entity">&amp;gt;</span>
</pre></div>
</div>
 </figure></notextile></div></p>

<p>Then i added the placeholder for the to be scaled image. And a div that will represent the slicer borders.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="entity">&amp;lt;</span>div id=&quot;image_slicer_canvas&quot;<span class="entity">&amp;gt;</span>
  <span class="tag">&lt;img</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">images/sample.jpg</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">alt</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">border</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">image_slicer_image</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span><span class="entity">&amp;lt;</span>/img<span class="entity">&amp;gt;</span>
  <span class="entity">&amp;lt;</span>div id=&quot;image_slicer&quot;<span class="entity">&amp;gt;</span>
    <span class="entity">&amp;lt;</span>div id=&quot;image_slicer_scaler&quot; class=&quot;ui-resizable-handle ui-resizable-se ui-icon ui-icon-gripsmall-diagonal-se&quot;<span class="entity">&amp;gt;</span><span class="entity">&amp;lt;</span>/div<span class="entity">&amp;gt;</span>
  <span class="entity">&amp;lt;</span>/div<span class="entity">&amp;gt;</span>
<span class="entity">&amp;lt;</span>/div<span class="entity">&amp;gt;</span>
</pre></div>
</div>
 </figure></notextile></div></p>

<p>The next thing to do is setup the scaling canvas. So let’s make it draggable and resizeable.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">// Create a draggable / scalable slicer</span>
<span class="predefined">$</span>(<span class="keyword">function</span>() {
  <span class="predefined">$</span>(<span class="error">‘</span><span class="error">#</span>image_slicer<span class="error">’</span>)
    .draggable({<span class="key">containment</span>:<span class="error">’</span><span class="error">#</span>image_slicer_canvas<span class="error">’</span>}) <span class="comment">// constraint</span>
    .resizable();&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">p&gt;

&lt;p&gt;</span><span class="delimiter">/</span></span>/ set the slicer canvas size
  resizeCanvas(
    <span class="predefined">$</span>(<span class="error">‘</span><span class="error">#</span>image_slicer_image<span class="error">’</span>).width(),
    <span class="predefined">$</span>(<span class="error">‘</span><span class="error">#</span>image_slicer_image<span class="error">’</span>).height()
  );
});
</pre></div>
</div>
 </figure></notextile></div></p>

<p>The only thing we need now is a bit of javascript to handle the slice action. I used a sample form to do the posting to the slicer.php script</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="comment">// handle slicer actions</span>
<span class="predefined">$</span>(<span class="error">‘</span><span class="error">#</span>image_slicer<span class="error">’</span>).resizable({
  <span class="function">stop</span>: <span class="keyword">function</span>(event, ui) { 
    <span class="keyword">var</span> pos = <span class="predefined">$</span>(<span class="error">‘</span><span class="error">#</span>image_slicer<span class="error">’</span>).position();&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">p&gt;

&lt;pre&gt;&lt;code&gt;</span><span class="delimiter">/</span></span>/ width, height, left, top
<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#scaler_width</span><span class="delimiter">'</span></span>).val(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#image_slicer</span><span class="delimiter">'</span></span>).width());
<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#scaler_height</span><span class="delimiter">'</span></span>).val(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#image_slicer</span><span class="delimiter">'</span></span>).height());
<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#scaler_left</span><span class="delimiter">'</span></span>).val(pos.left);
<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#scaler_top</span><span class="delimiter">'</span></span>).val(pos.top);   } }); </pre></div>
</div>
 </figure></notextile></div>
</code></pre>

<p>The result is a nice red dotted line (square) on top of the image. The dotted area is draggable and resizeable.
When the right slice is selected just hit the slice button and PHP/GD will do the rest.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
$width  = $_POST[‘width’];
$height = $_POST[‘height’]; 
$left   = $_POST[‘left’];
$top    = $_POST[‘top’];<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;p&gt;</span>// read source image
$src = imagecreatefromjpeg(‘images/sample.jpg’);
$dest = imagecreatetruecolor($width, $height);<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;p&gt;</span>imagecopy($dest, $src, 0, 0, $left, $top, $width, $height);<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;p&gt;</span>header(‘Content-Type: image/jpeg’);
imagegif($dest);<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;p&gt;</span>imagedestroy($dest);
imagedestroy($src);
</pre></div>
</div>
 </figure></notextile></div></p>

<p>That’s all. All files can be downloaded <a href="http://lenss.nl/images/2010/11/imageSlice.tar.gz">here</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Drag & drop Uploads with XMLHttpRequest2 and PHP Revised]]></title>
    <link href="http://lenss.nl/2010/09/drag-drop-uploads-with-xmlhttprequest2-and-php-revised/"/>
    <updated>2010-09-22T15:26:42+02:00</updated>
    <id>http://lenss.nl/2010/09/drag-drop-uploads-with-xmlhttprequest2-and-php-revised</id>
    <content type="html"><![CDATA[<p>A while back i wrote a <a href="http://lenss.nl/2010/01/drag-drop-uploads-with-xmlhttprequest2-and-php/">post </a> where i explained how to implement the new XMLHttpRequest2 object. The main point of the post was to use <a href="https://developer.mozilla.org/en/XMLHttpRequest">sendAsBinary()</a> so we can stream file uploads from the client to the server.</p>

<p>The post i made showed some code snippets to make this possible. And the Javascript part is all fine and dandy. But last week i had an interesting mail conversation with <a href="http://braincracking.org/">Jean-Pierre Vincent</a> about the memory consumption on the server side of things.</p>

<p>The result of some testing revealed the server would need at least the amount of memory equal to the file size. For small files this is no problem. But with bigger files this becomes a problem. Although i couldn’t reproduce Jean-Pierre’s results. I wasn’t very happy with the test results.</p>

<blockquote>

  <p>Upload 2.8 MB file results in 3.1 MB memory usage
Upload 29 MB file results in 30 MB memory usage</p>
</blockquote>

<p>A bit more testing revealed that <a href="http://php.net/manual/function.file-put-contents.php">file_put_contents()</a> was the culprit. Which seems logical if you think about it. It reads the file into memory and dumps it again. Not very elegant for big files. Besides we are trying to stream files. So why should we read them completely in to memory? We shouldn’t :)</p>

<p>Jean-Pierre decided to go with the DataForm object to solve the issue. I still want to look into that. But have not found any information about. Besides that i knew the problem was on the server side. So i rewrote the receive() method to be less memory intensive. The results are considerably better then before.</p>

<blockquote>

  <p>Upload 2.8 MB file results in 0.4 MB memory usage
Upload 29 MB file results in 0.4 MB memory usage</p>
</blockquote>

<p>The memory usage was measured with <a href="http://php.net/manual/function.memory-get-peak-usage.php">memory_get_peak_usage()</a>. And the new code is posted below:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">receive</span>()
    {
        <span class="keyword">if</span> (!<span class="local-variable">$this</span>-&amp;gt;isValid()) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="predefined-constant">Exception</span>(‘No <span class="predefined">file</span> uploaded!’);
        }&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    <span class="local-variable">$fileReader</span> = <span class="predefined">fopen</span>(<span class="string"><span class="delimiter">'</span><span class="content">php://input</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>);
    <span class="local-variable">$fileWriter</span> = <span class="predefined">fopen</span>(<span class="local-variable">$this</span>-&amp;gt;_destination . <span class="local-variable">$this</span>-&amp;gt;_fileName, <span class="string"><span class="delimiter">&quot;</span><span class="content">w+</span><span class="delimiter">&quot;</span></span>);

    <span class="keyword">while</span>(<span class="predefined-constant">true</span>) {
        <span class="local-variable">$buffer</span> = <span class="predefined">fgets</span>(<span class="local-variable">$fileReader</span>, <span class="integer">4096</span>);
        <span class="keyword">if</span> (<span class="predefined">strlen</span>(<span class="local-variable">$buffer</span>) == <span class="integer">0</span>) {
            <span class="predefined">fclose</span>(<span class="local-variable">$fileReader</span>);
            <span class="predefined">fclose</span>(<span class="local-variable">$fileWriter</span>);
            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }

        <span class="predefined">fwrite</span>(<span class="local-variable">$fileWriter</span>, <span class="local-variable">$buffer</span>);
    }

    <span class="keyword">return</span> <span class="predefined-constant">false</span>;
} </pre></div>
</div>
 </figure></notextile></div>
</code></pre>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Drag & drop Uploads with XMLHttpRequest2 and PHP]]></title>
    <link href="http://lenss.nl/2010/01/drag-drop-uploads-with-xmlhttprequest2-and-php/"/>
    <updated>2010-01-25T01:02:38+01:00</updated>
    <id>http://lenss.nl/2010/01/drag-drop-uploads-with-xmlhttprequest2-and-php</id>
    <content type="html"><![CDATA[<p>I finally had some time to read through my ever growing list must read items and play with some new software. While reading up on the new Firefox 3.6 i noticed it came with the new <a href="http://www.ideal.nl/">XMLHttpRequest</a> [<a href="http://www.w3.org/TR/XMLHttpRequest2/">2</a>] object based on the new <a href="http://dev.w3.org/2006/webapi/FileAPI/">file API</a>. And according to the new <a href="http://dev.w3.org/2006/webapi/FileAPI/">specs</a>. This would allow for easy file uploads. Now there’s been some <a href="http://hacks.mozilla.org/2009/12/uploading-files-with-xmlhttprequest/">examples</a> [<a href="http://arstechnica.com/open-source/news/2009/11/w3c-publishes-draft-of-new-file-api-spec.ars">2</a>] on the web already. But i just wanted to get my hands dirty.</p>

<p>The new XMLHttpRequest object makes is possible to send files in a few different formats. The most important being the binary format. The code for sending a request with XMLHttpRequest2 looks the same as the previous version. Except for sendAsBinary() in this case.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">p&gt;

&lt;p&gt;fileUpload = xhr.upload,
fileUpload.onload = function() {
  console.log(“Sent!”);
}&lt;</span><span class="delimiter">/</span></span>p&gt;

&lt;p&gt;xhr.open(<span class="error">“</span>POST<span class="error">”</span>, <span class="error">“</span>upload.php<span class="error">”</span>, <span class="predefined-constant">true</span>);
xhr.sendAsBinary(file.getAsBinary());
</pre></div>
</div>
 </figure></notextile></div></p>

<p>So let’s set things up for drag &amp; drop. We need a div that will be the main drop point. And we need some event listeners to catch the drag * drop events. Let start by creating the drop zone. For this we use two simple divs. The outer div will listen for the drag &amp; drop events. And the inner will catch the files.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="entity">&amp;lt;</span>div id=&quot;container&quot;<span class="entity">&amp;gt;</span>
  <span class="entity">&amp;lt;</span>div id=&quot;drop&quot;<span class="entity">&amp;gt;</span><span class="entity">&amp;lt;</span>/div<span class="entity">&amp;gt;</span>
<span class="entity">&amp;lt;</span>/div<span class="entity">&amp;gt;</span>
</pre></div>
</div>
 </figure></notextile></div></p>

<p>Now let’s create our upload code.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">var</span> upload = {
  <span class="function">setup</span> : <span class="keyword">function</span>() {},
  <span class="function">uploadFiles</span> : <span class="keyword">function</span>() {event}
}
window.addEventListener(<span class="error">“</span>load<span class="error">”</span>, upload.setup, <span class="predefined-constant">false</span>);
</pre></div>
</div>
 </figure></notextile></div></p>

<p>The setup method will set all event listeners for drag &amp; drop. And register the upload handler.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">var</span> container = document.getElementById(<span class="error">‘</span>container<span class="error">’</span>);
<span class="keyword">var</span> drop = document.getElementById(<span class="error">‘</span>drop<span class="error">’</span>);&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">p&gt;

&lt;p&gt;container.addEventListener(“dragenter”, function(event) {
    drop.innerHTML = ‘’;
    event.stopPropagation();
    event.preventDefault();
  }, 
  false
);&lt;</span><span class="delimiter">/</span></span>p&gt;

<span class="tag">&lt;p&gt;</span>container.addEventListener(“dragover”, function(event) {
    event.stopPropagation(); 
    event.preventDefault();
  }, 
  false
);<span class="tag">&lt;/p&gt;</span>

&lt;p&gt;container.addEventListener(<span class="error">“</span>drop<span class="error">”</span>, upload.uploadFiles, <span class="predefined-constant">false</span>);
</pre></div>
</div>
 </figure></notextile></div></p>

<p>As you could see above. the uploadFiles() method gets a event returned from the drag &amp; drop action. This is where the new <a href="http://dev.w3.org/2006/webapi/FileAPI/">file APi</a> comes in play. To get to the file property we access the dataTransfer object.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">var</span> files = event.dataTransfer.files;
</pre></div>
</div>
 </figure></notextile></div></p>

<p>The actual uploading is easy as cake.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
<span class="keyword">for</span> (<span class="keyword">var</span> x = <span class="integer">0</span>; x &amp;lt; files.length; x++) {&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">p&gt;

&lt;p&gt;var file = files.item(x);
  var xhr = new XMLHttpRequest();&lt;</span><span class="delimiter">/</span></span>p&gt;

<span class="tag">&lt;p&gt;</span>fileUpload = xhr.upload;
  fileUpload.onload = function() {
    console.log(“Sent!”);
  }<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;p&gt;</span>xhr.open(“POST”, “upload.php”, true);<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;p&gt;</span>xhr.setRequestHeader(“Cache-Control”, “no-cache”);
  xhr.setRequestHeader(“X-Requested-With”, “XMLHttpRequest”);
  xhr.setRequestHeader(“X-File-Name”, file.fileName);
  xhr.setRequestHeader(“X-File-Size”, file.fileSize);
  xhr.setRequestHeader(“Content-Type”, “multipart/form-data”);<span class="tag">&lt;/p&gt;</span>

&lt;p&gt;xhr.sendAsBinary(file.getAsBinary());
}
</pre></div>
</div>
 </figure></notextile></div></p>

<p>That’s it for the client side. There is however a small problem on the receiving side. When handling uploaded files in PHP we expect the <strong>$_FILES</strong> array to be populated. This is not the case when streaming files from the client to the server. To get the needed file information we set some headers on the client side <strong>X-File-Name</strong> and <strong>X-File-Size</strong>. And since the <strong>$_FILES</strong> are is empty. We need an other way to get the file contents. So we will use php://input streams for that.</p>

<p>The contents of upload.php look like this:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
require_once(‘Streamer.php’);<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;p&gt;</span>$ft = new File_Streamer();
$ft-<span class="entity">&amp;gt;</span>setDestination(‘data/’);
$ft-<span class="entity">&amp;gt;</span>receive();
</pre></div>
</div>
 </figure></notextile></div></p>

<p>With setDestination() the destination path for the uploaded files is set. And recieve() listens for any incoming files. Most of the magic is done in the recieve() method. So here’s the code.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>
public function receive()
{
  if (!$this-<span class="entity">&amp;gt;</span>isValid()) {
    throw new Exception(‘No file uploaded!’);
  }<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;p&gt;</span>file_put_contents(
    $this-<span class="entity">&amp;gt;</span>_destination . $this-<span class="entity">&amp;gt;</span>_fileName, 
    file_get_contents(“php://input”)
  );<span class="tag">&lt;/p&gt;</span>

<span class="tag">&lt;p&gt;</span>return true;
}
</pre></div>
</div>
 </figure></notextile></div></p>

<p>I am impressed! This promises a lot of good. And offers some interesting options. Let’s hope all browsers implement this gem. I still have one issue though. I can’t get this to work in firefox under linux. The drag &amp; drop events do not seem to function properly with files being dragged from the desktop. anybody know why? </p>

<p>If you interested in the complete code. you can find it <a href="http://lenss.nl/code/dragDropUpload.tar.gz">here</a></p>

<p><strong>**Small update</strong>**
<a href="http://lenss.nl/2010/09/drag-drop-uploads-with-xmlhttprequest2-and-php-revised/">http://lenss.nl/2010/09/drag-drop-uploads-with-xmlhttprequest2-and-php-revised/</a></p>
]]></content>
  </entry>
  
</feed>
