<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: PHP | Thijs Lensselink's Blog]]></title>
  <link href="http://tlenss.github.com/categories/php/atom.xml" rel="self"/>
  <link href="http://tlenss.github.com/"/>
  <updated>2012-11-15T21:36:32+01:00</updated>
  <id>http://tlenss.github.com/</id>
  <author>
    <name><![CDATA[Thijs Lensselink]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Publish Google Reader shared items]]></title>
    <link href="http://tlenss.github.com/2012/11/07/publish-google-reader-shared-items/"/>
    <updated>2012-11-07T15:55:26+01:00</updated>
    <id>http://tlenss.github.com/2012/11/07/publish-google-reader-shared-items</id>
    <content type="html"><![CDATA[<p>A lot of people are using the shared items feature in <a href="http://www.google.nl/reader/">Google Reader</a> to publish what they are reading on a blog. It's like having a live blogroll widget on your website. And gives your readers a good impression of what you are actually interested in.</p>

<p>I never bothered adding this to my blog. But i do like to share. So last night i was trying to figure out how to integrate this with my current blog. I was hoping for an easy implementation. But the information is scarce. So i had to do some digging. I did find a couple of <a href="https://www.google.nl/search?q=wordpress+plugin+google+reader">Wordpress plugins</a>. But most of them were not updated for at least a year. And i am not putting code like that life on my website.</p>

<p>After some Googling i came across a couple of feed URL's that seem to share their <strong>shared</strong> items in feed form. Using the Google Reader URL and a user id. So the URL for my shared items would look like the one below. Getting your user id by the way is easy. Go to your Google reader page. Click all <strong>All items</strong> and the <strong>UID</strong> will show up in the address bar.</p>

<blockquote><p>http://www.google.com/reader/shared/16525759780220726764</p></blockquote>

<p>The problem with this however. Non of my shared posts show up on this page. And i have not figured out a way to populate it just yet. So i came up with an other path to get this data on my server.</p>

<p>In the Google Reader pages it's possible to add sharing functionality. This is done by going to the <strong>Send To</strong> tab</p>

<p><a href="http://lenss.nl/images/2012/11/Send-To.png"><img src="http://lenss.nl/images/2012/11/Send-To-300x22.png" alt="" /></a></p>

<p>From here it's possible to select a service to share data with. Non of these services are any good for what i am trying to do. But the great thing about this page is. You can provide custom URL's for sharing data. Just incorporate the specified parameters in the URL and your done.</p>

<p><a href="http://lenss.nl/images/2012/11/Custom-Site.png"><img src="http://lenss.nl/images/2012/11/Custom-Site-300x178.png" alt="" /></a></p>

<p>Once configured and saved a custom URL is visible in the <strong>Send To</strong> panel</p>

<p><a href="http://lenss.nl/images/2012/11/Favorite-Site.png"><img src="http://lenss.nl/images/2012/11/Favorite-Site-300x125.png" alt="" /></a></p>

<p>That's it for this part. Actually sharing items is quite easy now. When back in the Google Reader under each post there is Send to link. If you click this link the newly created custom URL will show up. And you can share the post.</p>

<p><a href="http://lenss.nl/images/2012/11/Tag-Article.png"><img src="http://lenss.nl/images/2012/11/Tag-Article-300x41.png" alt="" /></a></p>

<p>The only thing left to do is write some code to process the incoming data. To get you started. Some of the code i used while testing this is posted below</p>

<pre><code>Class GoogleReaderShare
{
    const GOOGLE_REMOTE_IP = '95.97.54.3';

    const GOOGLE_REFERER = 'http://www.google.nl/reader/view/';

    protected static $_whitelist = array('source', 'title', 'url', 'short');

    public static function CheckSource($remoteAddr, $referer) 
    {
        if (($remoteAddr == self::GOOGLE_REMOTE_IP) 
                &amp;&amp; ($referer == self::GOOGLE_REFERER)) {
            return true;
        }
        return false;
    }

    protected static function _CheckIncomingData($data)
    {
        if (!is_array($data)) {
            return false;
        }

        foreach ($data as $key =&gt; $value) {
            if (!in_array($key, self::$_whitelist)) {
                return false;
            }
        }
    }

    public static function Process($data) 
    {
        if (!self::_CheckIncomingData($data)) {
            throw new Exception("Unrecognized or no incoming data");
        }

        // process the data
    }
}

if (GoogleReaderShare::CheckSource($_SERVER['REMOTE_ADDR'], $_SERVER['HTTP_REFERER'])) {
    GoogleReaderShare::Process($_GET);
}
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Long running PHP script and MySQL server gone away]]></title>
    <link href="http://tlenss.github.com/2012/10/29/long-running-php-script-and-mysql-server-gone-away/"/>
    <updated>2012-10-29T14:39:26+01:00</updated>
    <id>http://tlenss.github.com/2012/10/29/long-running-php-script-and-mysql-server-gone-away</id>
    <content type="html"><![CDATA[<p>At the moment i am writing some workers that interact with a <a href="http://kr.github.com/beanstalkd/">beanstalk</a> server. When data gets pushed into the beanstalk server. My workers will be triggered to process this data. So the workers are sitting idle for most of the time. And just wait for some data to process. No rocket science there. But during testing i kept running into <a href="http://www.mysql.com/">MySQL</a> issues. The script seemed to lose connection to the MySQL server when it was idle for longer then a minute. And would respond with a</p>

<blockquote><p>Warning: <a href="http://php.net/mysql_query">mysql_query</a>(): MySQL server has gone away in /path/to/some/mysql4/class.php on line xxx</p></blockquote>

<p>So whats going on here? Well actually it's quite simple. When my script initializes the database connection it doesn't use it. It just sits there waiting for incoming data. Once received it will process it and try to store it in the database. But when the waiting period exceeds the time for PHP to keep the MySQL connection open it responds with the warning mentioned above. Now in previous versions of PHP this would not be a big issue. As PHP would just initiate a reconnect when the connection is lost. But from PHP 5.0.3 and up this functionality has been disabled by default. For MySQLI this is no problem at all.</p>

<p>MySQLi:</p>

<blockquote><p>mysqli.reconnect = Off to On</p></blockquote>

<p>Unfortunately i am working with PHP's core mysql_* functions (don't get me started) and there doesn't seem to be an easy way to resolve this. According to the MySQL documentation</p>

<pre><code>mysql_options(&amp;mysql;, MYSQL_OPT_RECONNECT, &amp;reconnect;);
</code></pre>

<p>Should do the trick. But passing <strong>MYSQL_OPT_RECONNECT</strong> in anyway to <a href="http://php.net/mysql_connect">mysql_connect</a> didn't result in the result i was looking for. So what now? Porting the database code to make use of the newer and better PDO or MySQLi is no option. As it would consume way to much time. Fortunately the mysql_* core functions come with mysql_ping. I never had to use this before. But in this case it comes in quite handy.</p>

<p><strong>From the PHP manual:</strong></p>

<pre><code>bool mysql_ping ([ resource $link_identifier = NULL ] )
</code></pre>

<blockquote><p>Checks whether or not the connection to the server is working. If it has gone down, an automatic reconnection is attempted. This function can be used by scripts that remain idle for a long while, to check whether or not the server has closed the connection and reconnect if necessary.</p></blockquote>

<p>Note:
<strong>Automatic reconnection is disabled by default in versions of MySQL >= 5.0.3.</strong></p>

<p>Adding the mysql_ping function call was rather straight forward. And didn't require all that much work to be done. I extended the database class to include a ping method. That would simply throw an exception when it failed to reconnect.</p>

<pre><code>public function ping()
{
    if (!mysql_ping($this-&gt;db_connect_id)) {
        throw new Mollie_Database_Exception("Connection was lost");
    }   
    return true;
}
</code></pre>

<p>And after that i started poking around the userland implementation. The worker is running inside a <strong>while(true)</strong> loop. A first test with <strong>->ping()</strong> being called inside this loop proved to resolve the issue at hand. But running the ping function that often is overkill. And who knows it might actually result in <strong>DoS</strong> of the database server. So i decided to ping the server every one minute or so.</p>

<pre><code>$start = time();
while (true) 
{
    $this-&gt;_keepConnectionAlive($start);
</code></pre>

<p>And the keepConnectionAlive method looks something like this</p>

<pre><code>protected function _keepConnectionAlive(&amp;$start)
{
    $passed = (time() - $start);
    if ($passed &gt; 60)
    {
        $start = time();
        $this-&gt;_db-&gt;ping();
    }
}
</code></pre>

<p>I'm not a big fan of this solution. And would rather be implementing MySQLi functions. But this functions well. And will do for now.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Git: Rebase on pull by default]]></title>
    <link href="http://tlenss.github.com/2012/10/25/git-rebase-on-pull-by-default/"/>
    <updated>2012-10-25T14:20:22+02:00</updated>
    <id>http://tlenss.github.com/2012/10/25/git-rebase-on-pull-by-default</id>
    <content type="html"><![CDATA[<p>I was a bit surprised today when <a href="http://git-scm.com/">git</a> presented me a merge message window after i did a pull. This should not happen as the normal behavior here should be to <a href="http://git-scm.com/book/en/Git-Branching-Rebasing">rebase</a> the changes. But apparently that didn't happen this time. When i asked one of the other <a href="http://www.scriptorama.nl/">dev</a> 's what could be the issue. We quickly figured out i was just missing some <strong>config</strong> entry in <strong>.git/config</strong>. This probably happened some time ago when i did a fresh checkout.</p>

<p>So to make sure rebasing is done by default. You can run a simple git command or modify the <strong>.git/config</strong> file manually.</p>

<blockquote><p>$ git config branch.autosetuprebase always</p></blockquote>

<p>or do</p>

<blockquote><p>$ vi .git/config</p></blockquote>

<p>Make sure <strong>[branch "master"]</strong> has <strong>rebase</strong> set to true. It should look like the snippet below.</p>

<blockquote><p>[branch "master"]</p>

<pre><code>remote = origin
merge = refs/heads/master
rebase = true
</code></pre></blockquote>

<p>Starting to really like git. A couple of more quirks and things will be running fine.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Fixing character replacement in Wordpress]]></title>
    <link href="http://tlenss.github.com/2012/09/24/fixing-character-replacement-in-wordpress/"/>
    <updated>2012-09-24T21:39:17+02:00</updated>
    <id>http://tlenss.github.com/2012/09/24/fixing-character-replacement-in-wordpress</id>
    <content type="html"><![CDATA[<p>This has been bugging me for a while. But not enough to actually look into it. And Google searches for <a href="http://wordpress.org/">Wordpress</a> display wrong characters results in a whole forest of threads about UTF-8 encoding. This has nothing to do with that. So what's the issue here?</p>

<p>Wordpress is replacing characters in my posts. The most annoying being the replacement of -- <del>is</del> with - . Which makes no sense at all. Specially when creating code samples. Or command line parameters. My thought is why on earth would you do that? But it probably has something to do with typography...</p>

<p>Anyways. Searching for it today made me stumble onto <a href="http://blog.paulbetts.org/index.php/2007/06/01/stop-wordpress-from-turning-double-dash-into-long-dash/">this</a> post from 2007 by <a href="http://blog.paulbetts.org/">Paul Betts</a>. And believe it or not. Wordpress is still doing that. The code has changed slightly tough. So i created a quick patch as a temporary solution. And need to figure out if this can be circumvented by a plugin or something. If that doesn't exists already :)</p>

<p>The patch will replace the following lines</p>

<pre><code>$static_characters = array_merge( array( '---', ' -- ', '--', ' - ', 'xn-', '...', '``', '\'\'', ' (tm)' ), $cockney );
$static_replacements = array_merge( array( $em_dash, ' ' . $em_dash . ' ', $en_dash, ' ' . $en_dash . ' ', 'xn--', '…', $opening_quote, 
    $closing_quote, ' ™' ), $cockneyreplace 
);
</code></pre>

<p>With</p>

<pre><code>$static_characters = $cockney;
$static_replacements = $cockneyreplace;
</code></pre>

<p>Patching the file is easy.</p>

<p><strong>This patch was created for v3.4.2. And will most likely fail on other versions of Wordpress.</strong></p>

<blockquote><p>$ cd wp-includes/
$ wget <a href="https://raw.github.com/tlenss/misc/master/patch/wordpress-charreplace.patch">https://raw.github.com/tlenss/misc/master/patch/wordpress-charreplace.patch</a>
$ patch -p0 &lt; wordpress-charreplace.patch
patching file formatting.php</p></blockquote>

<p>That's all.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a basic PHP development environment with Vagrant and chef-solo]]></title>
    <link href="http://tlenss.github.com/2012/08/27/setup-a-basic-php-development-environment-with-vagrant-and-chef-solo/"/>
    <updated>2012-08-27T00:47:05+02:00</updated>
    <id>http://tlenss.github.com/2012/08/27/setup-a-basic-php-development-environment-with-vagrant-and-chef-solo</id>
    <content type="html"><![CDATA[<p>So there are plenty of posts about this out there already. And this is nothing new i guess. But i am going to post it anyway. This weekend i spend some time playing with vagrant. And every setup guide seemed to be missing some steps the make the whole process a bit of a hassle. So i compiled my own steps in the post below. The goal was to create a basic <a href="http://www.debian.org/">Debian</a> box for my <a href="http://www.php.net/">PHP</a> development. From which i could serve my local development files.</p>

<p>So to start of we need some packages.</p>

<p><strong>Virtualbox</strong></p>

<p>To create the virtual development image</p>

<p><strong>NFS packages</strong></p>

<p>To make sharing files between host and guest easy as pie</p>

<p><strong>Vagrant</strong></p>

<p>To package the virtual image and manage newly created box</p>

<blockquote><p>$ sudo apt-get install virtualbox vagrant nfs-common nfs-kernel-server</p></blockquote>

<p>Now is a good moment to download any Linux distro you want. I chose Debian. As it´s the most common in my day to day work.</p>

<blockquote><p>$ wget <a href="http://cdimage.debian.org/debian-cd/6.0.5/i386/iso-cd/debian-6.0.5-i386-netinst.iso">http://cdimage.debian.org/debian-cd/6.0.5/i386/iso-cd/debian-6.0.5-i386-netinst.iso</a></p></blockquote>

<p>Now launch <a href="https://www.virtualbox.org/">virtualbox</a> and create a new virtual machine. Just do what you normally do when you create a VM. But make sure to choose VMDK `Virtual Machine Disk´ as the format. The rest should be ok. When the VM is created start it up and choose the freshly downloaded Linux ISO to start the installation.</p>

<p>I only installed the base system + the SSH server. And when that's all done. And the VM is running. Login as root and install some packages vagrant needs.</p>

<blockquote><p>$ apt-get install sudo ruby ruby-dev libopenssl-ruby rdoc ri irb build-essential ssl-cert curl rubygems puppet</p></blockquote>

<p>I won't be setting up a <a href="http://www.opscode.com/chef/">Chef</a> server to manage the vagrant images. But i will be using <a href="http://wiki.opscode.com/display/chef/Installing+Chef+Client+and+Chef+Solo">Chef-Solo</a> to manage installing packages. So let's install Chef.</p>

<p><strong>install chef</strong></p>

<p>Setup the opscode package repositories for APT</p>

<blockquote><p>$ echo "deb http://apt.opscode.com/ <code>lsb_release -cs</code>-0.10 main" | tee /etc/apt/sources.list.d/opscode.list
$ gpg --keyserver keys.gnupg.net --recv-keys 83EF826A
$ gpg --export packages@opscode.com | tee /etc/apt/trusted.gpg.d/opscode-keyring.gpg > /dev/null</p></blockquote>

<p>And finally install the opscode keymanager and and of course Chef.</p>

<blockquote><p>$ apt-get update
$ apt-get install opscode-keyring
$ apt-get install chef</p></blockquote>

<p>The installer will ask for the chef URL. I used <strong>none</strong> because i will be using chef solo</p>

<p>Now we need to add a user for <a href="http://vagrantup.com/">vagrant</a> to connect with.</p>

<blockquote><p>$ adduser vagrant
  passwrd : vagrant
$ groupadd admin
$ usermod -a -G admin vagrant</p></blockquote>

<p>Make sure the admin users can <strong>sudo</strong> without a password.</p>

<blockquote><p>$ visudo
%admin  ALL=(ALL) NOPASSWD: ALL</p></blockquote>

<p>Disable DNS for the SSH server. This should be a performance gain.</p>

<blockquote><p>$ vi /etc/etc/ssh/sshd_config
UseDNS no</p></blockquote>

<p>Change the MOTD to something nice</p>

<blockquote><p>$ bash -c "echo 'Sweeet! A Vagrant box cooked by Chef!!' > /etc/motd"
$ chmod 0777 /etc/motd</p></blockquote>

<p>Switch to the vagrant user to setup the <strong>insecure</strong> vagrant public SSH key.</p>

<blockquote><p>$ su vagrant
mkdir -p ~/.ssh
chmod 0700 ~/.ssh
curl -o ~/.ssh/authorized_keys https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub
chmod 0600 ~/.ssh/authorized_keys</p></blockquote>

<p>That's it for the VM. Now it's time for vagrant to do some magic. First we need to create a vagrant package from the newly created VM.</p>

<blockquote><p>$ vagrant package --base devbox
$ mv package.box devbox.box</p></blockquote>

<p>Done! Let's test it.</p>

<blockquote><p>$ vagrant box add devbox devbox.box
$ mkdir test &amp;&amp; cd test
$ vagrant init devbox
$ vagrant up
$ vagrant ssh</p></blockquote>

<p>Voila ssh'd into the VM</p>

<blockquote><p>$ exit
$ vagrant halt
$ vagrant destroy</p></blockquote>

<p>So that's all fine and dandy. But a base system with SSH is not that useful. So that's where Chef comes in. Like i mentioned earlier i won't be using a Chef-Server. I will be using Chef-Solo. And will be doing a very basic setup.</p>

<p>A Chef install script is called a <a href="http://wiki.opscode.com/display/chef/Cookbooks">cookbook</a>. And they can be found all over the place. But the main repository is over here (find more here https://github.com/opscode/cookbooks). So in our vagrant folder we create a folder called cookbooks.</p>

<blockquote><p>$ mkdir cookbooks
$ cd cookbooks</p></blockquote>

<p>And we install some basic cookbooks. Plus a very simple one i hacked together to install the latest <a href="http://www.dotdeb.org/">dotdeb</a> package repositories.</p>

<p><a href="https://github.com/tlenss/misc/tree/master/chef/cookbooks/dotdeb">https://github.com/tlenss/misc/tree/master/chef/cookbooks/dotdeb</a></p>

<blockquote><p>$ git clone <a href="https://github.com/opscode/cookbooks">https://github.com/opscode/cookbooks</a></p></blockquote>

<p>This will be enough for now. And will allow for some basic PHP development. To enable these package we have to edit the <strong>Vagrantfile</strong> file.</p>

<blockquote><p>$ vi Vagrantfile</p></blockquote>

<p>Add these lines for apache forwarding and NFS sharing</p>

<blockquote><p>config.vm.share_folder "www", "/var/www", "/dev/location"</p></blockquote>

<p>uncomment the :hostonly line so we can acces apache from our local box. And setup a hosts file mapping</p>

<blockquote><p>config.vm.network :hostonly, "192.168.164.123"
$ sudo sed -i '$ a\
192.168.164.123 dev.box' /etc/hosts</p></blockquote>

<p>Configure chef's cookbook path and add some recipes from the cloned cookbooks.</p>

<blockquote><p>config.vm.provision :chef_solo do |chef|</p>

<pre><code>chef.json = {
    "mysql" =&gt; {
        "server_root_password" =&gt; "somepassword"
    "bind_address" =&gt; "127.0.0.1"
    }
}
</code></pre></blockquote>

<pre><code>chef.cookbooks_path = "cookbooks"
chef.add_recipe("dotdeb")
chef.add_recipe("dotdeb::php54")
chef.add_recipe("openssl")
chef.add_recipe("apache2")
chef.add_recipe("apache2::mod_php5")
chef.add_recipe("apache2::mod_rewrite")
chef.add_recipe("mysql")
chef.add_recipe("mysql::server")
chef.add_recipe("memcached")
chef.add_recipe("vim")
chef.add_recipe("php")
chef.add_recipe("php::module_curl")
chef.add_recipe("php::module_mysql")
chef.add_recipe("php::module_memcache")
chef.add_recipe("php::module_sqlite3")
</code></pre>

<p>end</p>

<p>Time to call vagrant again. And this time the startup takes a bit longer. All the selected packages get installed. And once that's done. And a fresh development box is waiting.</p>

<blockquote><p>$ vagrant up
$ vagrant ssh</p></blockquote>

<p>Let's check PHP</p>

<blockquote><p>$ php -v
PHP 5.4.6-1~dotdeb.0 (cli) (built: Aug 19 2012 08:45:58)
Copyright (c) 1997-2012 The PHP Group
Zend Engine v2.4.0, Copyright (c) 1998-2012 Zend Technologies</p></blockquote>

<p>What about apache?</p>

<blockquote><p>$ ps -aux | grep apache
root       790  0.1  0.2   5352  2580 ?        Ss   23:40   0:00 /usr/sbin/apache2 -k start
www-data   793  0.0  0.1   5124  1764 ?        S    23:40   0:00 /usr/sbin/apache2 -k start
www-data   797  0.0  0.2 546408  2412 ?        Sl   23:40   0:00 /usr/sbin/apache2 -k start
www-data   798  0.0  0.2 546408  2404 ?        Sl   23:40   0:00 /usr/sbin/apache2 -k start
www-data   811  0.0  0.2 546408  2424 ?        Sl   23:40   0:00 /usr/sbin/apache2 -k start</p></blockquote>

<p>Nice! And Pointing the browser to http://localhost:8080 loads the NFS shared folder up through Apache. That's it for now. Time to sleep...</p>

<p>Some sources i used:
[1] <a href="http://vagrantup.com/v1/docs/base_boxes.html">http://vagrantup.com/v1/docs/base_boxes.html</a>
[2] <a href="https://github.com/yevgenko/cookbook-dotdeb">https://github.com/yevgenko/cookbook-dotdeb</a>
[3] <a href="http://vagrantup.com/v1/docs/provisioners/chef_solo.html">http://vagrantup.com/v1/docs/provisioners/chef_solo.html</a></p>
]]></content>
  </entry>
  
</feed>
